/*
 * AudioStreamer.c
 *
 *  Created on: Feb 19, 2018
 *      Author: ericksong
 */
#include "AudioStreamer.h"

static void txCallback(I2S_Type *base, sai_edma_handle_t *handle, status_t status, void *userData)
{
    sai_transfer_t xfer = {0};

    sendCount++;
    if (sendCount == beginCount)
    {
        istxFinished = true;
        SAI_TransferTerminateSendEDMA(base, handle);
        sendCount = 0;
    }
    else
    {
        if (!sdcard)
        {
            xfer.data = audioBuff + ((sendCount - 1U) % BUFFER_NUM) * BUFFER_SIZE;
            xfer.dataSize = BUFFER_SIZE;
            SAI_TransferSendEDMA(base, handle, &xfer);
        }
    }
}

static void rxCallback(I2S_Type *base, sai_edma_handle_t *handle, status_t status, void *userData)
{
    sai_transfer_t xfer = {0};

    receiveCount++;

    if (receiveCount == beginCount)
    {
        isrxFinished = true;
        SAI_TransferTerminateReceiveEDMA(base, handle);
        receiveCount = 0;
    }
    else
    {
        if (!sdcard)
        {
            xfer.data = audioBuff + ((receiveCount - 1U) % BUFFER_NUM) * BUFFER_SIZE;
            xfer.dataSize = BUFFER_SIZE;
            SAI_TransferReceiveEDMA(base, handle, &xfer);
        }
    }
}

void Init_Dialog7212(void){
    sai_config_t config;
    uint32_t mclkSourceClockHz = 0U;
    edma_config_t dmaConfig = {0};

    i2c_master_config_t i2cConfig = {0};
    uint32_t i2cSourceClock;


    EDMA_GetDefaultConfig(&dmaConfig);
    EDMA_Init(EXAMPLE_DMA, &dmaConfig);
    EDMA_CreateHandle(&dmaTxHandle, EXAMPLE_DMA, EXAMPLE_TX_CHANNEL);
    EDMA_CreateHandle(&dmaRxHandle, EXAMPLE_DMA, EXAMPLE_RX_CHANNEL);

    DMAMUX_Init(EXAMPLE_DMAMUX);
    DMAMUX_SetSource(EXAMPLE_DMAMUX, EXAMPLE_TX_CHANNEL, (uint8_t)EXAMPLE_SAI_TX_SOURCE);
    DMAMUX_EnableChannel(EXAMPLE_DMAMUX, EXAMPLE_TX_CHANNEL);
    DMAMUX_SetSource(EXAMPLE_DMAMUX, EXAMPLE_RX_CHANNEL, (uint8_t)EXAMPLE_SAI_RX_SOURCE);
    DMAMUX_EnableChannel(EXAMPLE_DMAMUX, EXAMPLE_RX_CHANNEL);
}
